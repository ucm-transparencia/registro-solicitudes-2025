<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Solicitudes de Transparencia - UCM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8e8e8 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #b71234 0%, #8b0d27 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.95;
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
        }
        
        .control-item label {
            font-weight: 600;
            color: #2f2f2f;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-item select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-item select:hover {
            border-color: #b71234;
        }
        
        .control-item select:focus {
            outline: none;
            border-color: #b71234;
            box-shadow: 0 0 0 3px rgba(183, 18, 52, 0.1);
        }
        
        .view-toggles {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .view-toggle {
            flex: 1;
            min-width: 140px;
            padding: 12px 20px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .view-toggle:hover {
            border-color: #b71234;
            background: #fff5f7;
        }
        
        .view-toggle.active {
            background: #b71234;
            color: white;
            border-color: #b71234;
        }

        .download-section {
            padding: 20px 30px;
            background: #fff;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .download-section h3 {
            font-size: 16px;
            color: #2f2f2f;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .download-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #9B8942 0%, #8a7a3a 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #b5a363 0%, #9B8942 100%);
            box-shadow: 0 4px 12px rgba(155, 137, 66, 0.3);
            transform: translateY(-2px);
        }

        .download-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .chart-container {
            padding: 30px;
            position: relative;
            height: 500px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            padding: 20px 30px 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-card.favorable {
            border-left: 4px solid #28a745;
        }

        .stat-card.parcial {
            border-left: 4px solid #9B8942;
        }

        .stat-card.desfavorable {
            border-left: 4px solid #b71234;
        }

        .stat-card.inadmision {
            border-left: 4px solid #979492;
        }

        .stat-card.total {
            border-left: 4px solid #007bff;
        }
        
        .stat-card h3 {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card p {
            font-size: 32px;
            font-weight: 700;
            color: #2f2f2f;
        }
        
        .stat-card .percentage {
            font-size: 14px;
            margin-top: 5px;
            font-weight: 600;
            color: #6c757d;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        .table-container h2 {
            margin-bottom: 20px;
            color: #2f2f2f;
            font-size: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        thead {
            background: linear-gradient(135deg, #b71234 0%, #8b0d27 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.favorable {
            background: #d4edda;
            color: #155724;
        }

        .badge.parcial {
            background: #fff3cd;
            color: #856404;
        }

        .badge.desfavorable {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.inadmision {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .footer {
            padding: 20px 30px;
            background: #2f2f2f;
            color: white;
            text-align: center;
            font-size: 14px;
        }
        
        .footer a {
            color: #b71234;
            text-decoration: none;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            
            .control-group {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 350px;
                padding: 20px;
            }

            .download-section {
                flex-direction: column;
                align-items: stretch;
            }

            .download-btn {
                width: 100%;
                justify-content: center;
            }

            .table-container {
                padding: 15px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Registro de Solicitudes de Transparencia</h1>
            <p>Universidad Complutense de Madrid</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="year-select">A帽o</label>
                    <select id="year-select">
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                    </select>
                </div>
            </div>
            
            <div class="control-item">
                <label>Vista de Gr谩fico</label>
                <div class="view-toggles">
                    <button class="view-toggle active" data-view="bar"> Barras</button>
                    <button class="view-toggle" data-view="pie">ェ Circular</button>
                    <button class="view-toggle" data-view="line"> Evoluci贸n Anual</button>
                    <button class="view-toggle" data-view="percentage"> Porcentajes</button>
                </div>
            </div>
        </div>

        <div class="download-section">
            <h3> Descargar Datos:</h3>
            <button class="download-btn" id="downloadExcelBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Descargar Excel (.xlsx)
            </button>
            <button class="download-btn" id="downloadCsvBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Descargar CSV
            </button>
        </div>
        
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <!-- Se llenar谩 din谩micamente -->
        </div>

        <div class="table-container" id="tableContainer">
            <h2>Detalle de Solicitudes <span id="yearTitle"></span></h2>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>N潞 Expediente</th>
                        <th>Fecha Entrada</th>
                        <th>Resumen Solicitud</th>
                        <th>Forma Acceso</th>
                        <th>Tiempo Resoluci贸n</th>
                        <th>Sentido Resoluci贸n</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Se llenar谩 din谩micamente -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            Universidad Complutense de Madrid | Portal de Transparencia
        </div>
    </div>

    <script>
        const coloresUCM = {
            principal: '#b71234',
            gris: '#979492',
            dorado: '#9B8942',
            verde: '#28a745'
        };

        const datosSolicitudes = {
            "2022": {
                "total": 56,
                "favorable": 40,
                "parcialmente_favorable": 4,
                "desfavorable": 10,
                "inadmision": 2
            },
            "2023": {
                "total": 66,
                "favorable": 49,
                "parcialmente_favorable": 5,
                "desfavorable": 11,
                "inadmision": 1
            },
            "2024": {
                "total": 86,
                "favorable": 52,
                "parcialmente_favorable": 8,
                "desfavorable": 21,
                "inadmision": 5
            },
            "2025": {
                "total": 67,
                "favorable": 43,
                "parcialmente_favorable": 8,
                "desfavorable": 10,
                "inadmision": 6
            }
        };

        // Datos completos para la tabla (simulados - se cargar铆an de los archivos)
        const datosCompletos = {
            "2025": [] // Se llenar谩 con datos reales
        };

        let chart = null;
        let currentView = 'bar';
        const yearSelect = document.getElementById('year-select');
        const viewToggles = document.querySelectorAll('.view-toggle');
        const statsGrid = document.getElementById('statsGrid');

        function init() {
            actualizarVisualizacion();
            
            yearSelect.addEventListener('change', actualizarVisualizacion);
            
            viewToggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    viewToggles.forEach(t => t.classList.remove('active'));
                    toggle.classList.add('active');
                    currentView = toggle.dataset.view;
                    actualizarGrafico();
                });
            });

            document.getElementById('downloadExcelBtn').addEventListener('click', descargarExcel);
            document.getElementById('downloadCsvBtn').addEventListener('click', descargarCSV);
        }

        function actualizarVisualizacion() {
            actualizarEstadisticas();
            actualizarGrafico();
            actualizarTabla();
        }

        function actualizarEstadisticas() {
            const year = yearSelect.value;
            const datos = datosSolicitudes[year];
            
            statsGrid.innerHTML = `
                <div class="stat-card total">
                    <h3>Total Solicitudes</h3>
                    <p>${datos.total}</p>
                </div>
                <div class="stat-card favorable">
                    <h3>Favorable</h3>
                    <p>${datos.favorable}</p>
                    <div class="percentage">${((datos.favorable / datos.total) * 100).toFixed(1)}%</div>
                </div>
                <div class="stat-card parcial">
                    <h3>Parcialmente Favorable</h3>
                    <p>${datos.parcialmente_favorable}</p>
                    <div class="percentage">${((datos.parcialmente_favorable / datos.total) * 100).toFixed(1)}%</div>
                </div>
                <div class="stat-card desfavorable">
                    <h3>Desfavorable</h3>
                    <p>${datos.desfavorable}</p>
                    <div class="percentage">${((datos.desfavorable / datos.total) * 100).toFixed(1)}%</div>
                </div>
                <div class="stat-card inadmision">
                    <h3>Inadmisi贸n</h3>
                    <p>${datos.inadmision}</p>
                    <div class="percentage">${((datos.inadmision / datos.total) * 100).toFixed(1)}%</div>
                </div>
            `;
        }

        function actualizarGrafico() {
            const year = yearSelect.value;
            const datos = datosSolicitudes[year];
            
            if (chart) chart.destroy();

            const ctx = document.getElementById('mainChart').getContext('2d');
            let config = {};
            
            switch(currentView) {
                case 'bar': config = crearGraficoBarras(datos); break;
                case 'pie': config = crearGraficoPie(datos); break;
                case 'line': config = crearGraficoLinea(); break;
                case 'percentage': config = crearGraficoPorcentaje(datos); break;
            }
            
            chart = new Chart(ctx, config);
        }

        function crearGraficoBarras(datos) {
            return {
                type: 'bar',
                data: {
                    labels: ['Favorable', 'Parcialmente Favorable', 'Desfavorable', 'Inadmisi贸n'],
                    datasets: [{
                        label: 'N煤mero de Solicitudes',
                        data: [datos.favorable, datos.parcialmente_favorable, datos.desfavorable, datos.inadmision],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(155, 137, 66, 0.7)',
                            'rgba(183, 18, 52, 0.7)',
                            'rgba(151, 148, 146, 0.7)'
                        ],
                        borderColor: [
                            '#28a745',
                            coloresUCM.dorado,
                            coloresUCM.principal,
                            coloresUCM.gris
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `Solicitudes de Transparencia ${yearSelect.value}`,
                            font: { size: 18, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 5 }
                        }
                    }
                }
            };
        }

        function crearGraficoPie(datos) {
            return {
                type: 'doughnut',
                data: {
                    labels: ['Favorable', 'Parcialmente Favorable', 'Desfavorable', 'Inadmisi贸n'],
                    datasets: [{
                        data: [datos.favorable, datos.parcialmente_favorable, datos.desfavorable, datos.inadmision],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(155, 137, 66, 0.8)',
                            'rgba(183, 18, 52, 0.8)',
                            'rgba(151, 148, 146, 0.8)'
                        ],
                        borderColor: '#fff',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { font: { size: 14 }, padding: 20 }
                        },
                        title: {
                            display: true,
                            text: `Distribuci贸n de Resoluciones ${yearSelect.value}`,
                            font: { size: 18, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            };
        }

        function crearGraficoLinea() {
            const years = Object.keys(datosSolicitudes).sort();
            const favorable = years.map(y => datosSolicitudes[y].favorable);
            const parcial = years.map(y => datosSolicitudes[y].parcialmente_favorable);
            const desfavorable = years.map(y => datosSolicitudes[y].desfavorable);
            const inadmision = years.map(y => datosSolicitudes[y].inadmision);
            
            return {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Favorable',
                            data: favorable,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Parcialmente Favorable',
                            data: parcial,
                            borderColor: coloresUCM.dorado,
                            backgroundColor: 'rgba(155, 137, 66, 0.2)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Desfavorable',
                            data: desfavorable,
                            borderColor: coloresUCM.principal,
                            backgroundColor: 'rgba(183, 18, 52, 0.2)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Inadmisi贸n',
                            data: inadmision,
                            borderColor: coloresUCM.gris,
                            backgroundColor: 'rgba(151, 148, 146, 0.2)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 12 }, padding: 15 } },
                        title: {
                            display: true,
                            text: 'Evoluci贸n Anual de Solicitudes (2022-2025)',
                            font: { size: 18, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 5 }
                        }
                    }
                }
            };
        }

        function crearGraficoPorcentaje(datos) {
            const porcentajes = [
                ((datos.favorable / datos.total) * 100).toFixed(1),
                ((datos.parcialmente_favorable / datos.total) * 100).toFixed(1),
                ((datos.desfavorable / datos.total) * 100).toFixed(1),
                ((datos.inadmision / datos.total) * 100).toFixed(1)
            ];

            return {
                type: 'bar',
                data: {
                    labels: ['Favorable', 'Parcialmente Favorable', 'Desfavorable', 'Inadmisi贸n'],
                    datasets: [{
                        label: 'Porcentaje (%)',
                        data: porcentajes,
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(155, 137, 66, 0.7)',
                            'rgba(183, 18, 52, 0.7)',
                            'rgba(151, 148, 146, 0.7)'
                        ],
                        borderColor: [
                            '#28a745',
                            coloresUCM.dorado,
                            coloresUCM.principal,
                            coloresUCM.gris
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `Distribuci贸n Porcentual ${yearSelect.value}`,
                            font: { size: 18, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            };
        }

        function actualizarTabla() {
            const year = yearSelect.value;
            document.getElementById('yearTitle').textContent = year;
            
            // Nota: Aqu铆 se cargar铆an los datos reales del a帽o seleccionado
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">Los datos detallados se descargan con los botones de Excel o CSV</td></tr>';
        }

        function descargarCSV() {
            const year = yearSelect.value;
            const datos = datosSolicitudes[year];
            
            let csv = 'Tipo de Resoluci贸n,Cantidad,Porcentaje\n';
            csv += `Favorable,${datos.favorable},${((datos.favorable / datos.total) * 100).toFixed(2)}%\n`;
            csv += `Parcialmente Favorable,${datos.parcialmente_favorable},${((datos.parcialmente_favorable / datos.total) * 100).toFixed(2)}%\n`;
            csv += `Desfavorable,${datos.desfavorable},${((datos.desfavorable / datos.total) * 100).toFixed(2)}%\n`;
            csv += `Inadmisi贸n,${datos.inadmision},${((datos.inadmision / datos.total) * 100).toFixed(2)}%\n`;
            csv += `\nTotal,${datos.total},100%\n`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Solicitudes_Transparencia_${year}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function descargarExcel() {
            const year = yearSelect.value;
            const datos = datosSolicitudes[year];
            
            const dataArray = [
                ['Registro de Solicitudes de Transparencia UCM - ' + year],
                [],
                ['Tipo de Resoluci贸n', 'Cantidad', 'Porcentaje'],
                ['Favorable', datos.favorable, ((datos.favorable / datos.total) * 100).toFixed(2) + '%'],
                ['Parcialmente Favorable', datos.parcialmente_favorable, ((datos.parcialmente_favorable / datos.total) * 100).toFixed(2) + '%'],
                ['Desfavorable', datos.desfavorable, ((datos.desfavorable / datos.total) * 100).toFixed(2) + '%'],
                ['Inadmisi贸n', datos.inadmision, ((datos.inadmision / datos.total) * 100).toFixed(2) + '%'],
                [],
                ['Total', datos.total, '100%']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(dataArray);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Solicitudes');
            
            XLSX.writeFile(wb, `Solicitudes_Transparencia_${year}.xlsx`);
        }

        init();
    </script>
</body>
</html>
